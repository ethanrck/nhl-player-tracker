<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DangleData - NHL Player Line Tracker</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üèí</text></svg>">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --bg-gradient-start: #1e3c72;
            --bg-gradient-end: #2a5298;
            --container-bg: white;
            --text-primary: #1e3c72;
            --text-secondary: #666;
            --card-bg: #f8f9fa;
            --card-hover-border: #2a5298;
            --button-bg: white;
            --button-text: #2a5298;
            --button-active-bg: #2a5298;
            --button-active-text: white;
            --modal-overlay: rgba(0,0,0,0.7);
            --table-header-bg: #2a5298;
            --table-border: #ddd;
            --input-border: #ddd;
            --warning-bg: #fff3cd;
            --warning-text: #856404;
            --success-bg: #d4edda;
            --success-text: #155724;
            --error-bg: #f8d7da;
            --error-text: #721c24;
            --hit-bg: #d4edda;
            --miss-bg: #f8d7da;
        }
        
        body.dark-mode {
            --bg-gradient-start: #0a1929;
            --bg-gradient-end: #1a2332;
            --container-bg: #1e2936;
            --text-primary: #e3f2fd;
            --text-secondary: #b0bec5;
            --card-bg: #263238;
            --card-hover-border: #4fc3f7;
            --button-bg: #263238;
            --button-text: #4fc3f7;
            --button-active-bg: #4fc3f7;
            --button-active-text: #0a1929;
            --modal-overlay: rgba(0,0,0,0.85);
            --table-header-bg: #1565c0;
            --table-border: #37474f;
            --input-border: #37474f;
            --warning-bg: #3e2723;
            --warning-text: #ffb74d;
            --success-bg: #1b5e20;
            --success-text: #81c784;
            --error-bg: #b71c1c;
            --error-text: #ef5350;
            --hit-bg: #2e7d32;
            --miss-bg: #c62828;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
            min-height: 100vh;
            padding: 20px;
            transition: all 0.3s ease;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: var(--container-bg);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
        }
        
        .header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        h1 {
            color: var(--text-primary);
            font-size: 2.5em;
            transition: color 0.3s ease;
        }
        
        .dark-mode-toggle {
            background: var(--button-bg);
            color: var(--button-text);
            border: 2px solid var(--button-text);
            border-radius: 8px;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }
        
        .dark-mode-toggle:hover {
            background: var(--button-active-bg);
            color: var(--button-active-text);
        }
        
        .subtitle {
            text-align: center;
            color: var(--text-secondary);
            margin-bottom: 20px;
            transition: color 0.3s ease;
        }
        
        .api-status {
            background: var(--warning-bg);
            color: var(--warning-text);
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            align-items: center;
            background: var(--card-bg);
            padding: 20px;
            border-radius: 10px;
            transition: all 0.3s ease;
        }
        
        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        label {
            font-weight: 600;
            color: var(--text-primary);
            transition: color 0.3s ease;
        }
        
        input[type="text"], input[type="checkbox"], select {
            padding: 10px;
            font-size: 16px;
            border: 2px solid var(--input-border);
            border-radius: 8px;
            background: var(--container-bg);
            color: var(--text-primary);
            transition: all 0.3s ease;
        }
        
        select {
            cursor: pointer;
        }
        
        select option {
            background: var(--container-bg);
            color: var(--text-primary);
        }
        
        input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .stat-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .stat-button {
            padding: 12px 24px;
            background: var(--button-bg);
            color: var(--button-text);
            border: 2px solid var(--button-text);
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .stat-button:hover {
            opacity: 0.8;
        }
        
        .stat-button.active {
            background: var(--button-active-bg);
            color: var(--button-active-text);
        }
        
        .search-box {
            flex-grow: 1;
            min-width: 250px;
        }
        
        .players-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .player-card {
            background: var(--card-bg);
            border-radius: 10px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }
        
        .player-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            border-color: var(--card-hover-border);
        }
        
        .player-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 5px;
        }
        
        .player-name {
            font-size: 1.2em;
            font-weight: bold;
            color: var(--text-primary);
            flex: 1;
            transition: color 0.3s ease;
        }
        
        .odds-line {
            font-size: 0.9em;
            font-weight: 600;
            color: #e67e22;
            background: var(--warning-bg);
            padding: 4px 8px;
            border-radius: 4px;
            white-space: nowrap;
            margin-left: 10px;
        }
        
        .player-team {
            color: var(--text-secondary);
            font-size: 0.9em;
            margin-bottom: 10px;
            transition: color 0.3s ease;
        }
        
        .player-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 10px;
        }
        
        .stat {
            text-align: center;
        }
        
        .stat-label {
            font-size: 0.8em;
            color: var(--text-secondary);
            transition: color 0.3s ease;
        }
        
        .stat-value {
            font-size: 1.3em;
            font-weight: bold;
            color: var(--text-primary);
            transition: color 0.3s ease;
        }
        
        .hit-rate-display {
            margin-top: 10px;
            padding: 10px;
            background: var(--container-bg);
            border-radius: 5px;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .hit-rate-value {
            font-size: 1.5em;
            font-weight: bold;
        }
        
        .hit-rate-excellent {
            color: #27ae60;
        }
        
        .hit-rate-good {
            color: #2ecc71;
        }
        
        .hit-rate-medium {
            color: #f39c12;
        }
        
        .hit-rate-poor {
            color: #e74c3c;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
            font-size: 18px;
            transition: color 0.3s ease;
        }
        
        .error {
            background: var(--error-bg);
            color: var(--error-text);
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            transition: all 0.3s ease;
        }
        
        .game-log-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--modal-overlay);
            z-index: 1000;
            overflow-y: auto;
            padding: 20px;
            transition: all 0.3s ease;
        }
        
        .modal-content {
            background: var(--container-bg);
            max-width: 1000px;
            margin: 20px auto;
            border-radius: 15px;
            padding: 30px;
            position: relative;
            transition: all 0.3s ease;
        }
        
        .close-modal {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 30px;
            cursor: pointer;
            color: var(--text-secondary);
            transition: color 0.3s ease;
        }
        
        .close-modal:hover {
            color: var(--text-primary);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        th {
            background: var(--table-header-bg);
            color: white;
            padding: 12px;
            text-align: left;
        }
        
        td {
            padding: 12px;
            border-bottom: 1px solid var(--table-border);
            color: var(--text-primary);
            transition: all 0.3s ease;
        }
        
        tr:hover {
            background: var(--card-bg);
        }
        
        .hit {
            background-color: var(--hit-bg) !important;
        }
        
        .miss {
            background-color: var(--miss-bg) !important;
        }
        
        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .summary-card {
            background: var(--card-bg);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .summary-label {
            font-size: 0.9em;
            color: var(--text-secondary);
            margin-bottom: 5px;
            transition: color 0.3s ease;
        }
        
        .summary-value {
            font-size: 1.8em;
            font-weight: bold;
            color: var(--text-primary);
            transition: color 0.3s ease;
        }
        
        .h2h-section {
            background: var(--warning-bg);
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            transition: all 0.3s ease;
        }
        
        .h2h-title {
            font-size: 1.1em;
            font-weight: bold;
            color: var(--warning-text);
            margin-bottom: 10px;
            text-align: center;
        }
        
        .h2h-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
        }
        
        .h2h-stat {
            text-align: center;
            padding: 10px;
            background: var(--container-bg);
            border-radius: 5px;
        }
        
        .h2h-stat-label {
            font-size: 0.85em;
            color: var(--text-secondary);
            margin-bottom: 3px;
        }
        
        .h2h-stat-value {
            font-size: 1.3em;
            font-weight: bold;
            color: var(--text-primary);
        }
        
        h2, h3 {
            color: var(--text-primary);
            transition: color 0.3s ease;
        }
        
        p {
            color: var(--text-secondary);
            transition: color 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-row">
            <h1>üèí DangleData</h1>
            <button class="dark-mode-toggle" onclick="toggleDarkMode()">üåô Dark Mode</button>
        </div>
        <p class="subtitle">NHL Player Line Tracker - 2025-2026 Season</p>
        
        <div class="api-status" id="apiStatus">
            üìä Loading cached data...
        </div>
        
        <div class="controls">
            <div class="control-group search-box">
                <label>Search Player:</label>
                <input type="text" id="searchPlayer" placeholder="Type player name..." oninput="filterPlayers()" style="flex-grow: 1;">
            </div>
            
            <div class="control-group">
                <label>Filter by Game:</label>
                <select id="gameFilter" onchange="filterPlayers()" style="padding: 10px; font-size: 16px; border: 2px solid var(--input-border); border-radius: 8px; background: var(--container-bg); color: var(--text-primary); min-width: 250px;">
                    <option value="">All Games</option>
                </select>
            </div>
            
            <div class="control-group">
                <input type="checkbox" id="hideNoLines" onchange="filterPlayers()">
                <label for="hideNoLines">Hide players without betting lines</label>
            </div>
        </div>
        
        <div style="background: var(--card-bg); padding: 20px; border-radius: 10px; margin-bottom: 20px; transition: all 0.3s ease;">
            <label style="display: block; margin-bottom: 10px; font-weight: 600; color: var(--text-primary);">Select Stat:</label>
            <div class="stat-buttons">
                <button class="stat-button active" onclick="selectStat('points')">Points</button>
                <button class="stat-button" onclick="selectStat('goals')">Goals</button>
                <button class="stat-button" onclick="selectStat('assists')">Assists</button>
                <button class="stat-button" onclick="selectStat('shots')">Shots</button>
                <button class="stat-button" onclick="selectStat('saves')">Goalie Saves</button>
            </div>
        </div>
        
        <div id="playersContainer" class="players-grid">
            <div class="loading">Loading all players from cache...</div>
        </div>
        
        <div id="playersContainer" class="players-grid">
            <div class="loading">Loading all players from cache...</div>
        </div>
        
        <!-- Watchlist Section - Compact Corner Popup -->
        <div id="watchlistSection" style="position: fixed; bottom: 20px; right: 20px; width: 400px; max-height: 600px; background: var(--container-bg); border: 3px solid var(--button-active-bg); border-radius: 12px; box-shadow: 0 5px 30px rgba(0,0,0,0.4); z-index: 999; display: none; transition: all 0.3s ease; overflow: hidden;">
            <div style="background: var(--button-active-bg); color: white; padding: 12px 15px; display: flex; justify-content: space-between; align-items: center;">
                <h4 style="margin: 0; font-size: 1em; cursor: pointer;" onclick="toggleWatchlistSection()">üìã Watchlist (<span id="watchlistCount">0</span>)</h4>
                <div style="display: flex; gap: 8px;">
                    <button id="watchlistToggle" onclick="toggleWatchlistSection()" style="background: none; border: none; font-size: 20px; cursor: pointer; color: white;">‚ñº</button>
                    <button onclick="hideWatchlist()" style="background: none; border: none; font-size: 20px; cursor: pointer; color: white;" title="Minimize">‚àí</button>
                </div>
            </div>
            <div id="watchlistContent" style="max-height: 550px; overflow-y: auto;">
                <div id="parlayCalculator" style="display: none; padding: 15px; border-bottom: 2px solid var(--input-border);"></div>
                <div id="watchlistItems" style="padding: 10px;"></div>
            </div>
        </div>
        
        <!-- Watchlist Toggle Button (when collapsed) -->
        <button id="watchlistFloatingButton" onclick="showWatchlist()" style="position: fixed; bottom: 20px; right: 20px; width: 60px; height: 60px; border-radius: 50%; background: var(--button-active-bg); color: white; border: none; font-size: 24px; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.3); z-index: 998; display: none; transition: all 0.3s;">
            üìã<span id="floatingCount" style="position: absolute; top: -5px; right: -5px; background: #e74c3c; color: white; border-radius: 50%; width: 24px; height: 24px; font-size: 12px; display: flex; align-items: center; justify-content: center; font-weight: bold;">0</span>
        </button>
        
        <script>
        function showWatchlist() {
            document.getElementById('watchlistSection').style.display = 'block';
            document.getElementById('watchlistFloatingButton').style.display = 'none';
            document.getElementById('watchlistContent').style.display = 'block';
            document.getElementById('watchlistToggle').textContent = '‚ñº';
        }
        
        function hideWatchlist() {
            if (watchlist.length > 0) {
                document.getElementById('watchlistSection').style.display = 'none';
                document.getElementById('watchlistFloatingButton').style.display = 'flex';
            }
        }
        </script>
        
        </div>
        
        <!-- Watchlist Section -->
        <div id="watchlistSection" style="position: fixed; bottom: 0; left: 0; right: 0; background: var(--container-bg); border-top: 3px solid var(--button-active-bg); box-shadow: 0 -5px 20px rgba(0,0,0,0.3); z-index: 999; display: none; transition: all 0.3s ease;">
            <div style="max-width: 1400px; margin: 0 auto; padding: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; cursor: pointer;" onclick="toggleWatchlistSection()">
                    <h3 style="margin: 0; color: var(--text-primary);">üìã My Watchlist (<span id="watchlistCount">0</span>)</h3>
                    <button id="watchlistToggle" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-primary);">‚ñº</button>
                </div>
                <div id="watchlistItems" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; max-height: 400px; overflow-y: auto;"></div>
            </div>
        </div>
    </div>
    
    <div id="gameLogModal" class="game-log-modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal()">&times;</span>
            <div id="modalContent"></div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'https://nhl-player-tracker.vercel.app';
        
        let allPlayersData = [];
        let allGoaliesData = [];
        let allGameLogs = {};
        let allGoalieGameLogs = {};
        let teamShotData = [];
        let filteredPlayers = [];
        let playerHitRates = {};
        let bettingOdds = {};
        let currentStatType = 'points';
        let isGoalieMode = false;
        let watchlist = [];
        let selectedForParlay = [];

        // Load watchlist from localStorage
        function loadWatchlist() {
            const saved = localStorage.getItem('dangledata_watchlist');
            if (saved) {
                watchlist = JSON.parse(saved);
            }
            updateWatchlistDisplay();
        }

        // Save watchlist to localStorage
        function saveWatchlist() {
            localStorage.setItem('dangledata_watchlist', JSON.stringify(watchlist));
            updateWatchlistDisplay();
        }

        // Toggle player in watchlist
        function toggleWatchlist(playerId, playerName) {
            const index = watchlist.findIndex(p => p.id === playerId);
            if (index > -1) {
                watchlist.splice(index, 1);
                // Remove from parlay selection if it was selected
                selectedForParlay = selectedForParlay.filter(id => id !== playerId);
            } else {
                watchlist.push({ id: playerId, name: playerName, stat: currentStatType });
                // Auto-expand watchlist when adding first player
                if (watchlist.length === 1) {
                    document.getElementById('watchlistItems').style.display = 'grid';
                    document.getElementById('watchlistToggle').textContent = '‚ñº';
                }
            }
            saveWatchlist();
            displayPlayers(); // Refresh to update button states
            
            // If modal is open, refresh it to show updated button state
            if (document.getElementById('gameLogModal').style.display === 'block') {
                showGameLog(playerId);
            }
        }

        // Check if player is in watchlist
        function isInWatchlist(playerId) {
            return watchlist.some(p => p.id === playerId);
        }

        // Toggle player selection for parlay
        function toggleParlaySelection(playerId) {
            const index = selectedForParlay.indexOf(playerId);
            if (index > -1) {
                selectedForParlay.splice(index, 1);
            } else {
                selectedForParlay.push(playerId);
            }
            updateWatchlistDisplay();
        }

        // Convert American odds to decimal
        function americanToDecimal(americanOdds) {
            if (americanOdds > 0) {
                return (americanOdds / 100) + 1;
            } else {
                return (100 / Math.abs(americanOdds)) + 1;
            }
        }

        // Convert decimal odds to American
        function decimalToAmerican(decimalOdds) {
            if (decimalOdds >= 2) {
                return '+' + Math.round((decimalOdds - 1) * 100);
            } else {
                return Math.round(-100 / (decimalOdds - 1));
            }
        }

        // Calculate parlay odds
        function calculateParlay() {
            if (selectedForParlay.length === 0) return null;
            
            let totalDecimalOdds = 1;
            const legs = [];
            
            selectedForParlay.forEach(playerId => {
                const item = watchlist.find(w => w.id === playerId);
                if (!item) return;
                
                const playerSource = isGoalieMode ? allGoaliesData : allPlayersData;
                const player = playerSource.find(p => p.playerId === item.id);
                if (!player) return;
                
                const name = isGoalieMode ? 
                    (player.goalieFullName || 'Unknown') : 
                    (player.skaterFullName || 'Unknown');
                const playerOdds = bettingOdds[name];
                
                if (playerOdds && playerOdds[item.stat]) {
                    const odds = playerOdds[item.stat];
                    const decimalOdds = americanToDecimal(odds.odds);
                    totalDecimalOdds *= decimalOdds;
                    
                    legs.push({
                        name,
                        stat: item.stat,
                        line: odds.line,
                        odds: odds.odds
                    });
                }
            });
            
            if (legs.length === 0) return null;
            
            return {
                legs,
                decimalOdds: totalDecimalOdds,
                americanOdds: decimalToAmerican(totalDecimalOdds),
                legCount: legs.length
            };
        }

        // Update watchlist display at bottom
        function updateWatchlistDisplay() {
            const watchlistContainer = document.getElementById('watchlistItems');
            const watchlistSection = document.getElementById('watchlistSection');
            const watchlistCount = document.getElementById('watchlistCount');
            
            watchlistCount.textContent = watchlist.length;
            
            if (watchlist.length === 0) {
                watchlistSection.style.display = 'none';
                return;
            }
            
            watchlistSection.style.display = 'block';
            
            const items = watchlist.map(item => {
                const playerSource = isGoalieMode ? allGoaliesData : allPlayersData;
                const player = playerSource.find(p => p.playerId === item.id);
                
                if (!player) return '';
                
                const name = isGoalieMode ? 
                    (player.goalieFullName || 'Unknown') : 
                    (player.skaterFullName || 'Unknown');
                const playerOdds = bettingOdds[name];
                const hasOdds = playerOdds && playerOdds[item.stat];
                
                let oddsInfo = '';
                if (hasOdds) {
                    const odds = playerOdds[item.stat];
                    const formattedOdds = odds.odds > 0 ? `+${odds.odds}` : odds.odds;
                    if (item.stat === 'goals' && odds.type === 'anytime_scorer') {
                        oddsInfo = `Anytime Goal ${formattedOdds}`;
                    } else {
                        oddsInfo = `O/U ${odds.line} ${formattedOdds}`;
                    }
                }
                
                // Get hit rate
                const gameLogSource = isGoalieMode ? allGoalieGameLogs : allGameLogs;
                const gameLog = gameLogSource[player.playerId];
                let hitRate = 'N/A';
                
                if (gameLog && playerOdds && playerOdds[item.stat]) {
                    const lineValue = playerOdds[item.stat].line;
                    let games = gameLog.gameLog;
                    if (isGoalieMode) {
                        games = games.filter(game => {
                            const shotsAgainst = game.shotsAgainst || 0;
                            const gamesStarted = game.gamesStarted || 0;
                            return gamesStarted > 0 || shotsAgainst > 0;
                        });
                    }
                    games = games.slice(0, 10);
                    
                    let hits = 0;
                    games.forEach(game => {
                        let statValue = 0;
                        if (isGoalieMode) {
                            const shotsAgainst = game.shotsAgainst || 0;
                            const goalsAgainst = game.goalsAgainst || 0;
                            statValue = shotsAgainst - goalsAgainst;
                        } else {
                            if (item.stat === 'points') statValue = game.points || 0;
                            else if (item.stat === 'goals') statValue = game.goals || 0;
                            else if (item.stat === 'assists') statValue = game.assists || 0;
                            else if (item.stat === 'shots') statValue = game.shots || 0;
                        }
                        if (statValue > lineValue) hits++;
                    });
                    
                    if (games.length > 0) {
                        hitRate = `${((hits / games.length) * 100).toFixed(0)}% (${hits}/${games.length})`;
                    }
                }
                
                return `
                    <div style="background: var(--card-bg); padding: 15px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; border: 2px solid var(--input-border);">
                        <div style="flex: 1;">
                            <div style="font-weight: bold; color: var(--text-primary); margin-bottom: 5px;">${name}</div>
                            <div style="font-size: 0.85em; color: var(--text-secondary);">${item.stat.toUpperCase()} ‚Ä¢ ${oddsInfo || 'No line'}</div>
                            <div style="font-size: 0.85em; color: var(--text-secondary); margin-top: 3px;">Hit Rate: ${hitRate}</div>
                        </div>
                        <button onclick="toggleWatchlist(${item.id}, '${name}')" style="background: #e74c3c; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600;">Remove</button>
                    </div>
                `;
            }).filter(Boolean).join('');
            
            watchlistContainer.innerHTML = items || '<div style="color: var(--text-secondary); text-align: center; padding: 20px;">No players in watchlist</div>';
        }

        // Toggle watchlist visibility
        function toggleWatchlistSection() {
            const content = document.getElementById('watchlistContent');
            const toggle = document.getElementById('watchlistToggle');
            const isHidden = content.style.display === 'none';
            
            if (isHidden) {
                content.style.display = 'block';
                toggle.textContent = '‚ñº';
            } else {
                content.style.display = 'none';
                toggle.textContent = '‚ñ≤';
            }
        }

        // Clear all parlay selections
        function clearParlaySelections() {
            selectedForParlay = [];
            updateWatchlistDisplay();
        }

        // Dark mode toggle
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('darkMode', isDark);
            
            const btn = document.querySelector('.dark-mode-toggle');
            btn.textContent = isDark ? '‚òÄÔ∏è Light Mode' : 'üåô Dark Mode';
        }

        // Load dark mode preference
        window.onload = function() {
            const darkMode = localStorage.getItem('darkMode') === 'true';
            if (darkMode) {
                document.body.classList.add('dark-mode');
                document.querySelector('.dark-mode-toggle').textContent = '‚òÄÔ∏è Light Mode';
            }
            loadWatchlist();
            loadCachedData();
        };

        async function loadCachedData() {
            const container = document.getElementById('playersContainer');
            container.innerHTML = '<div class="loading">Loading all players from cache...</div>';

            try {
                const response = await fetch(`${API_BASE_URL}/api/get-data`);
                
                if (!response.ok) {
                    throw new Error(`Failed to fetch cached data: ${response.status}`);
                }
                
                const data = await response.json();
                
                allPlayersData = data.allPlayers || [];
                allGoaliesData = data.allGoalies || [];
                allGameLogs = data.gameLogs || {};
                allGoalieGameLogs = data.goalieGameLogs || {};
                bettingOdds = data.bettingOdds || {};
                teamShotData = data.teamShotData || [];
                
                allPlayersData = allPlayersData.filter(p => (p.gamesPlayed || 0) > 0);
                allGoaliesData = allGoaliesData.filter(g => (g.gamesPlayed || 0) > 0);
                filteredPlayers = [...allPlayersData];
                
                const statusDiv = document.getElementById('apiStatus');
                const bettingLinesCount = data.stats?.bettingLinesLoaded || 0;
                const goalieCount = allGoaliesData.length;
                const teamCount = teamShotData.length;
                statusDiv.innerHTML = `‚úÖ Loaded ${allPlayersData.length} players | ${goalieCount} goalies | ${teamCount} teams | ${data.stats.gameLogsLoaded} game logs | ${bettingLinesCount} betting lines | Last updated: ${new Date(data.lastUpdated).toLocaleString()}`;
                statusDiv.style.background = 'var(--success-bg)';
                statusDiv.style.color = 'var(--success-text)';
                
                // Apply initial filter based on checkbox state
                filterPlayers();
                
                // Populate game filter dropdown
                populateGameFilter();

            } catch (error) {
                container.innerHTML = `<div class="error"><strong>Error loading cached data:</strong> ${error.message}</div>`;
                console.error('Error:', error);
            }
        }

        function populateGameFilter() {
            const gameFilter = document.getElementById('gameFilter');
            const uniqueGames = new Set();
            
            // Extract all unique games from betting odds
            Object.values(bettingOdds).forEach(playerOdds => {
                Object.values(playerOdds).forEach(statOdds => {
                    if (statOdds.game) {
                        uniqueGames.add(statOdds.game);
                    }
                });
            });
            
            // Sort games by time
            const gamesWithTime = Array.from(uniqueGames).map(game => {
                // Find the game time from any player who has odds for this game
                let gameTime = null;
                for (const playerOdds of Object.values(bettingOdds)) {
                    for (const statOdds of Object.values(playerOdds)) {
                        if (statOdds.game === game) {
                            gameTime = new Date(statOdds.gameTime);
                            break;
                        }
                    }
                    if (gameTime) break;
                }
                return { game, gameTime };
            }).sort((a, b) => a.gameTime - b.gameTime);
            
            // Clear existing options except "All Games"
            gameFilter.innerHTML = '<option value="">All Games</option>';
            
            // Add game options with time
            gamesWithTime.forEach(({ game, gameTime }) => {
                const option = document.createElement('option');
                option.value = game;
                const timeStr = gameTime.toLocaleString('en-US', { 
                    weekday: 'short', 
                    month: 'short', 
                    day: 'numeric', 
                    hour: 'numeric', 
                    minute: '2-digit' 
                });
                option.textContent = `${game} - ${timeStr}`;
                gameFilter.appendChild(option);
            });
            
            console.log(`Populated ${uniqueGames.size} games in filter`);
        }

        function selectStat(stat) {
            currentStatType = stat;
            isGoalieMode = (stat === 'saves');
            
            document.querySelectorAll('.stat-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Manually activate the correct button
            const buttons = document.querySelectorAll('.stat-button');
            buttons.forEach(btn => {
                const btnText = btn.textContent.toLowerCase();
                if ((stat === 'saves' && btnText.includes('goalie')) ||
                    (stat === 'points' && btnText === 'points') ||
                    (stat === 'goals' && btnText === 'goals') ||
                    (stat === 'assists' && btnText === 'assists') ||
                    (stat === 'shots' && btnText === 'shots')) {
                    btn.classList.add('active');
                }
            });
            
            // Switch between skaters and goalies
            if (isGoalieMode) {
                filteredPlayers = [...allGoaliesData];
            } else {
                filteredPlayers = [...allPlayersData];
            }
            
            // Reset game filter when switching stats
            document.getElementById('gameFilter').value = '';
            populateGameFilter();
            
            filterPlayers();
        }

        function filterPlayers() {
            const searchTerm = document.getElementById('searchPlayer').value.toLowerCase();
            const hideNoLines = document.getElementById('hideNoLines').checked;
            const selectedGame = document.getElementById('gameFilter').value;
            
            const sourceData = isGoalieMode ? allGoaliesData : allPlayersData;
            
            filteredPlayers = sourceData.filter(player => {
                const fullName = isGoalieMode ? 
                    `${player.goalieFullName || ''}`.toLowerCase() : 
                    `${player.skaterFullName || ''}`.toLowerCase();
                const matchesSearch = searchTerm === '' || fullName.includes(searchTerm);
                
                const name = isGoalieMode ? 
                    (player.goalieFullName || 'Unknown Goalie') : 
                    (player.skaterFullName || 'Unknown Player');
                const playerOdds = bettingOdds[name];
                const hasLine = playerOdds && playerOdds[currentStatType];
                const passesLineFilter = !hideNoLines || hasLine;
                
                // Game filter
                let passesGameFilter = true;
                if (selectedGame && playerOdds && playerOdds[currentStatType]) {
                    passesGameFilter = playerOdds[currentStatType].game === selectedGame;
                }
                
                return matchesSearch && passesLineFilter && passesGameFilter;
            });
            
            displayPlayers();
        }

        function getHitRateColor(hitRate) {
            if (hitRate >= 70) return 'hit-rate-excellent';
            if (hitRate >= 50) return 'hit-rate-good';
            if (hitRate >= 30) return 'hit-rate-medium';
            return 'hit-rate-poor';
        }
        
        // Normalize team names to handle accent variations
        function normalizeTeamName(name) {
            return name.normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase();
        }
        
        // Convert number to ordinal (1st, 2nd, 3rd, etc.)
        function getOrdinal(n) {
            const s = ["th", "st", "nd", "rd"];
            const v = n % 100;
            return n + (s[(v - 20) % 10] || s[v] || s[0]);
        }

        function getOpponentFromGame(gameString, playerTeam) {
            // gameString format: "Team A vs Team B"
            const teams = gameString.split(' vs ');
            // Map abbreviations to full names
            const teamMappings = {
                'TOR': 'Toronto Maple Leafs', 'BOS': 'Boston Bruins', 'TBL': 'Tampa Bay Lightning',
                'FLA': 'Florida Panthers', 'MTL': 'Montreal Canadiens', 'OTT': 'Ottawa Senators',
                'BUF': 'Buffalo Sabres', 'DET': 'Detroit Red Wings', 'NYR': 'New York Rangers',
                'NYI': 'New York Islanders', 'NJD': 'New Jersey Devils', 'PIT': 'Pittsburgh Penguins',
                'WSH': 'Washington Capitals', 'PHI': 'Philadelphia Flyers', 'CBJ': 'Columbus Blue Jackets',
                'CAR': 'Carolina Hurricanes', 'NSH': 'Nashville Predators', 'WPG': 'Winnipeg Jets',
                'MIN': 'Minnesota Wild', 'COL': 'Colorado Avalanche', 'DAL': 'Dallas Stars',
                'CHI': 'Chicago Blackhawks', 'STL': 'St. Louis Blues', 'VGK': 'Vegas Golden Knights',
                'EDM': 'Edmonton Oilers', 'CGY': 'Calgary Flames', 'VAN': 'Vancouver Canucks',
                'SEA': 'Seattle Kraken', 'SJS': 'San Jose Sharks', 'ANA': 'Anaheim Ducks',
                'LAK': 'Los Angeles Kings', 'ARI': 'Arizona Coyotes', 'UTA': 'Utah Hockey Club'
            };
            
            const playerTeamFullName = teamMappings[playerTeam];
            
            if (teams[0].trim() === playerTeamFullName) {
                return teams[1].trim();
            } else {
                return teams[0].trim();
            }
        }

        function getTeamShotInfo(teamFullName) {
            // Find matching team in teamShotData
            const teamInfo = teamShotData.find(t => 
                t.teamFullName === teamFullName || 
                teamFullName.includes(t.abbrev)
            );
            return teamInfo || null;
        }

        function displayPlayers() {
            const container = document.getElementById('playersContainer');
            
            const playersWithHitRates = filteredPlayers.map(player => {
                const name = isGoalieMode ? 
                    (player.goalieFullName || 'Unknown Goalie') : 
                    (player.skaterFullName || 'Unknown Player');
                const playerOdds = bettingOdds[name];
                const hasOdds = playerOdds && playerOdds[currentStatType];
                
                let lineValue = 0.5;
                if (hasOdds) {
                    lineValue = playerOdds[currentStatType].line;
                }
                
                const gameLogSource = isGoalieMode ? allGoalieGameLogs : allGameLogs;
                const gameLog = gameLogSource[player.playerId];
                let hitRate = 0;
                let gamesPlayed = 0;
                
                if (gameLog && gameLog.gameLog && gameLog.gameLog.length > 0) {
                    // Filter games - for goalies, only include games where they actually played
                    let games = gameLog.gameLog;
                    if (isGoalieMode) {
                        games = games.filter(game => {
                            const shotsAgainst = game.shotsAgainst || 0;
                            const gamesStarted = game.gamesStarted || 0;
                            return gamesStarted > 0 || shotsAgainst > 0;
                        });
                    }
                    games = games.slice(0, 10);
                    gamesPlayed = games.length;
                    let hits = 0;
                    
                    games.forEach(game => {
                        let statValue = 0;
                        if (isGoalieMode) {
                            // Calculate saves: shots against - goals against
                            const shotsAgainst = game.shotsAgainst || 0;
                            const goalsAgainst = game.goalsAgainst || 0;
                            statValue = shotsAgainst - goalsAgainst;
                        } else {
                            if (currentStatType === 'points') statValue = game.points || 0;
                            else if (currentStatType === 'goals') statValue = game.goals || 0;
                            else if (currentStatType === 'assists') statValue = game.assists || 0;
                            else if (currentStatType === 'shots') statValue = game.shots || 0;
                        }
                        
                        if (statValue > lineValue) hits++;
                    });
                    
                    hitRate = (hits / games.length) * 100;
                }
                
                return { player, hasOdds, hitRate, gamesPlayed };
            });
            
            playersWithHitRates.sort((a, b) => {
                if (a.hasOdds && !b.hasOdds) return -1;
                if (!a.hasOdds && b.hasOdds) return 1;
                
                if (a.hasOdds && b.hasOdds) {
                    if (a.gamesPlayed >= 4 && b.gamesPlayed >= 4) {
                        return b.hitRate - a.hitRate;
                    }
                    if (a.gamesPlayed >= 4 && b.gamesPlayed < 4) return -1;
                    if (a.gamesPlayed < 4 && b.gamesPlayed >= 4) return 1;
                    return (b.player.points || 0) - (a.player.points || 0);
                }
                
                return (b.player.points || 0) - (a.player.points || 0);
            });
            
            if (playersWithHitRates.length === 0) {
                container.innerHTML = '<div class="loading">No players found.</div>';
                return;
            }
            
            let html = playersWithHitRates.map(({player, hasOdds}) => {
                const name = isGoalieMode ? 
                    (player.goalieFullName || 'Unknown Goalie') : 
                    (player.skaterFullName || 'Unknown Player');
                const team = player.teamAbbrevs || 'N/A';
                const gamesPlayed = player.gamesPlayed || 0;
                
                let stat1Label, stat1Value, stat2Label, stat2Value, stat3Label, stat3Value;
                
                if (isGoalieMode) {
                    stat1Label = 'Saves';
                    stat1Value = player.saves || 0;
                    stat2Label = 'GAA';
                    stat2Value = (player.goalsAgainstAverage || 0).toFixed(2);
                    stat3Label = 'SV%';
                    stat3Value = (player.savePct || 0).toFixed(3);
                } else {
                    stat1Label = 'Goals';
                    stat1Value = player.goals || 0;
                    stat2Label = 'Assists';
                    stat2Value = player.assists || 0;
                    stat3Label = 'Points';
                    stat3Value = player.points || 0;
                }
                
                const position = isGoalieMode ? 'G' : (player.positionCode || 'N/A');
                
                const playerOdds = bettingOdds[name];
                let oddsDisplay = '';
                
                if (hasOdds) {
                    const oddsInfo = playerOdds[currentStatType];
                    const line = oddsInfo.line;
                    const price = oddsInfo.odds;
                    const formattedOdds = price > 0 ? `+${price}` : price;
                    
                    if (currentStatType === 'goals' && oddsInfo.type === 'anytime_scorer') {
                        oddsDisplay = `<div class="odds-line">Anytime Goal ${formattedOdds}</div>`;
                    } else {
                        oddsDisplay = `<div class="odds-line">O/U ${line} ${formattedOdds}</div>`;
                    }
                }
                
                return `
                    <div class="player-card" onclick="showGameLog(${player.playerId})">
                        <div class="player-header">
                            <div class="player-name">${name}</div>
                            ${oddsDisplay}
                        </div>
                        <div class="player-team">${team} - ${position} | GP: ${gamesPlayed}</div>
                        <div class="player-stats">
                            <div class="stat">
                                <div class="stat-label">${stat1Label}</div>
                                <div class="stat-value">${stat1Value}</div>
                            </div>
                            <div class="stat">
                                <div class="stat-label">${stat2Label}</div>
                                <div class="stat-value">${stat2Value}</div>
                            </div>
                            <div class="stat">
                                <div class="stat-label">${stat3Label}</div>
                                <div class="stat-value">${stat3Value}</div>
                            </div>
                        </div>
                        <div class="hit-rate-display" id="hitrate-${player.playerId}">
                            <div class="stat-label">Calculating...</div>
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = html;
            updateAllHitRates();
        }

        function updateAllHitRates() {
            // Use requestAnimationFrame to prevent blocking
            requestAnimationFrame(() => {
                const batchSize = 20;
                let currentIndex = 0;
                
                function processBatch() {
                    const batch = filteredPlayers.slice(currentIndex, currentIndex + batchSize);
                    
                    batch.forEach(player => {
                        try {
                            const name = isGoalieMode ? 
                                (player.goalieFullName || 'Unknown Goalie') : 
                                (player.skaterFullName || 'Unknown Player');
                            const playerOdds = bettingOdds[name];
                            let lineValue = 0.5;
                            
                            if (playerOdds && playerOdds[currentStatType]) {
                                lineValue = playerOdds[currentStatType].line;
                            }
                            
                            const gameLogSource = isGoalieMode ? allGoalieGameLogs : allGameLogs;
                            const gameLog = gameLogSource[player.playerId];
                            
                            const hitRateDiv = document.getElementById(`hitrate-${player.playerId}`);
                            
                            if (!hitRateDiv) {
                                console.log(`Hit rate div not found for ${name} (${player.playerId})`);
                                return; // Skip if element doesn't exist
                            }
                            
                            if (!gameLog || !gameLog.gameLog || !Array.isArray(gameLog.gameLog) || gameLog.gameLog.length === 0) {
                                hitRateDiv.innerHTML = `<div class="stat-label">No game log available</div>`;
                                playerHitRates[player.playerId] = 0;
                                return;
                            }

                            // Filter games - for goalies, only include games where they actually played
                            let games = [...gameLog.gameLog]; // Create a copy
                            if (isGoalieMode) {
                                games = games.filter(game => {
                                    const shotsAgainst = game.shotsAgainst || 0;
                                    const gamesStarted = game.gamesStarted || 0;
                                    return gamesStarted > 0 || shotsAgainst > 0;
                                });
                            }
                            games = games.slice(0, 10);
                            
                            if (games.length === 0) {
                                hitRateDiv.innerHTML = `<div class="stat-label">No games played</div>`;
                                playerHitRates[player.playerId] = 0;
                                return;
                            }
                            
                            let hits = 0;

                            games.forEach(game => {
                                let statValue = 0;
                                if (isGoalieMode) {
                                    const shotsAgainst = game.shotsAgainst || 0;
                                    const goalsAgainst = game.goalsAgainst || 0;
                                    statValue = shotsAgainst - goalsAgainst;
                                } else {
                                    if (currentStatType === 'points') statValue = game.points || 0;
                                    else if (currentStatType === 'goals') statValue = game.goals || 0;
                                    else if (currentStatType === 'assists') statValue = game.assists || 0;
                                    else if (currentStatType === 'shots') statValue = game.shots || 0;
                                }
                                
                                if (statValue > lineValue) hits++;
                            });

                            const hitRate = games.length > 0 ? ((hits / games.length) * 100).toFixed(1) : 0;
                            playerHitRates[player.playerId] = parseFloat(hitRate);
                            
                            const colorClass = getHitRateColor(parseFloat(hitRate));
                            
                            hitRateDiv.innerHTML = `
                                <div class="stat-label">Last ${games.length} Games vs ${lineValue}</div>
                                <div class="hit-rate-value ${colorClass}">${hitRate}% (${hits}/${games.length})</div>
                            `;
                        } catch (error) {
                            console.error(`Error calculating hit rate for player ${player.playerId} (${player.skaterFullName || player.goalieFullName}):`, error);
                            const hitRateDiv = document.getElementById(`hitrate-${player.playerId}`);
                            if (hitRateDiv) {
                                hitRateDiv.innerHTML = `<div class="stat-label">Error</div>`;
                            }
                        }
                    });
                    
                    currentIndex += batchSize;
                    
                    // Process next batch
                    if (currentIndex < filteredPlayers.length) {
                        requestAnimationFrame(processBatch);
                    }
                }
                
                processBatch();
            });
        }

        function calculateH2HStats(games, opponent) {
            const h2hGames = games.filter(game => game.opponentAbbrev === opponent);
            
            if (h2hGames.length === 0) return null;
            
            let totalGoals = 0;
            let totalAssists = 0;
            let totalPoints = 0;
            let totalShots = 0;
            
            h2hGames.forEach(game => {
                totalGoals += game.goals || 0;
                totalAssists += game.assists || 0;
                totalPoints += game.points || 0;
                totalShots += game.shots || 0;
            });
            
            return {
                games: h2hGames.length,
                avgGoals: (totalGoals / h2hGames.length).toFixed(2),
                avgAssists: (totalAssists / h2hGames.length).toFixed(2),
                avgPoints: (totalPoints / h2hGames.length).toFixed(2),
                avgShots: (totalShots / h2hGames.length).toFixed(2),
                totalGoals,
                totalAssists,
                totalPoints
            };
        }

        function showGameLog(playerId) {
            // Check if we're in goalie mode and use appropriate data sources
            const gameLogSource = isGoalieMode ? allGoalieGameLogs : allGameLogs;
            const playerSource = isGoalieMode ? allGoaliesData : allPlayersData;
            
            const gameLog = gameLogSource[playerId];
            
            if (!gameLog || !gameLog.gameLog || gameLog.gameLog.length === 0) {
                alert('Game log not available for this player');
                return;
            }

            const player = playerSource.find(p => p.playerId === playerId);
            const name = isGoalieMode ? 
                (player.goalieFullName || 'Unknown Goalie') : 
                (player.skaterFullName || 'Unknown Player');
            
            const playerOdds = bettingOdds[name];
            let lineValue = 0.5;
            let nextOpponent = null;
            
            if (playerOdds && playerOdds[currentStatType]) {
                lineValue = playerOdds[currentStatType].line;
                // Extract opponent from game string (e.g., "Toronto Maple Leafs vs Boston Bruins")
                const gameStr = playerOdds[currentStatType].game;
                const teams = gameStr.split(' vs ');
                const playerTeamFull = player.teamAbbrevs; // This is the abbreviation like "TOR"
                
                // Get full team name from abbreviation
                const teamFullNames = {
                    'TOR': 'Toronto Maple Leafs', 'BOS': 'Boston Bruins', 'TBL': 'Tampa Bay Lightning',
                    'FLA': 'Florida Panthers', 'MTL': 'Montreal Canadiens', 'OTT': 'Ottawa Senators',
                    'BUF': 'Buffalo Sabres', 'DET': 'Detroit Red Wings', 'NYR': 'New York Rangers',
                    'NYI': 'New York Islanders', 'NJD': 'New Jersey Devils', 'PIT': 'Pittsburgh Penguins',
                    'WSH': 'Washington Capitals', 'PHI': 'Philadelphia Flyers', 'CBJ': 'Columbus Blue Jackets',
                    'CAR': 'Carolina Hurricanes', 'NSH': 'Nashville Predators', 'WPG': 'Winnipeg Jets',
                    'MIN': 'Minnesota Wild', 'COL': 'Colorado Avalanche', 'DAL': 'Dallas Stars',
                    'CHI': 'Chicago Blackhawks', 'STL': 'St. Louis Blues', 'VGK': 'Vegas Golden Knights',
                    'EDM': 'Edmonton Oilers', 'CGY': 'Calgary Flames', 'VAN': 'Vancouver Canucks',
                    'SEA': 'Seattle Kraken', 'SJS': 'San Jose Sharks', 'ANA': 'Anaheim Ducks',
                    'LAK': 'Los Angeles Kings', 'ARI': 'Arizona Coyotes', 'UTA': 'Utah Hockey Club'
                };
                
                const playerTeamFullName = teamFullNames[playerTeamFull];
                
                // Determine which team is the opponent
                if (playerTeamFullName && teams[0].trim() === playerTeamFullName) {
                    nextOpponent = teams[1].trim();
                } else {
                    nextOpponent = teams[0].trim();
                }
                
                console.log('Next opponent detected:', nextOpponent);
            }

            // Filter games - for goalies, only include games where they actually played
            let games = gameLog.gameLog;
            if (isGoalieMode) {
                games = games.filter(game => {
                    const shotsAgainst = game.shotsAgainst || 0;
                    const gamesStarted = game.gamesStarted || 0;
                    // Only include if they started the game or faced shots
                    return gamesStarted > 0 || shotsAgainst > 0;
                });
            }
            games = games.slice(0, 10);
            let hits = 0;

            const gameRows = games.map(game => {
                let statValue = 0;
                
                if (isGoalieMode) {
                    // Calculate saves: shots against - goals against
                    const shotsAgainst = game.shotsAgainst || 0;
                    const goalsAgainst = game.goalsAgainst || 0;
                    statValue = shotsAgainst - goalsAgainst;
                } else {
                    if (currentStatType === 'points') statValue = game.points || 0;
                    else if (currentStatType === 'goals') statValue = game.goals || 0;
                    else if (currentStatType === 'assists') statValue = game.assists || 0;
                    else if (currentStatType === 'shots') statValue = game.shots || 0;
                }

                const hit = statValue > lineValue;
                if (hit) hits++;

                const opponent = game.opponentAbbrev || 'N/A';
                const homeAway = game.homeRoadFlag === 'H' ? 'vs' : '@';
                const gameDate = new Date(game.gameDate).toLocaleDateString();

                if (isGoalieMode) {
                    // Get opponent shot ranking
                    const teamFullNames = {
                        'TOR': 'Toronto Maple Leafs', 'BOS': 'Boston Bruins', 'TBL': 'Tampa Bay Lightning',
                        'FLA': 'Florida Panthers', 'MTL': 'Montr√©al Canadiens', 'OTT': 'Ottawa Senators',
                        'BUF': 'Buffalo Sabres', 'DET': 'Detroit Red Wings', 'NYR': 'New York Rangers',
                        'NYI': 'New York Islanders', 'NJD': 'New Jersey Devils', 'PIT': 'Pittsburgh Penguins',
                        'WSH': 'Washington Capitals', 'PHI': 'Philadelphia Flyers', 'CBJ': 'Columbus Blue Jackets',
                        'CAR': 'Carolina Hurricanes', 'NSH': 'Nashville Predators', 'WPG': 'Winnipeg Jets',
                        'MIN': 'Minnesota Wild', 'COL': 'Colorado Avalanche', 'DAL': 'Dallas Stars',
                        'CHI': 'Chicago Blackhawks', 'STL': 'St. Louis Blues', 'VGK': 'Vegas Golden Knights',
                        'EDM': 'Edmonton Oilers', 'CGY': 'Calgary Flames', 'VAN': 'Vancouver Canucks',
                        'SEA': 'Seattle Kraken', 'SJS': 'San Jose Sharks', 'ANA': 'Anaheim Ducks',
                        'LAK': 'Los Angeles Kings', 'ARI': 'Arizona Coyotes', 'UTA': 'Utah Mammoth'
                    };
                    
                    const teamMascots = {
                        'Toronto Maple Leafs': 'Maple Leafs', 'Boston Bruins': 'Bruins', 'Tampa Bay Lightning': 'Lightning',
                        'Florida Panthers': 'Panthers', 'Montr√©al Canadiens': 'Canadiens', 'Montreal Canadiens': 'Canadiens', 
                        'Ottawa Senators': 'Senators', 'Buffalo Sabres': 'Sabres', 'Detroit Red Wings': 'Red Wings', 
                        'New York Rangers': 'Rangers', 'New York Islanders': 'Islanders', 'New Jersey Devils': 'Devils', 
                        'Pittsburgh Penguins': 'Penguins', 'Washington Capitals': 'Capitals', 'Philadelphia Flyers': 'Flyers', 
                        'Columbus Blue Jackets': 'Blue Jackets', 'Carolina Hurricanes': 'Hurricanes', 'Nashville Predators': 'Predators', 
                        'Winnipeg Jets': 'Jets', 'Minnesota Wild': 'Wild', 'Colorado Avalanche': 'Avalanche', 'Dallas Stars': 'Stars',
                        'Chicago Blackhawks': 'Blackhawks', 'St. Louis Blues': 'Blues', 'Vegas Golden Knights': 'Golden Knights',
                        'Edmonton Oilers': 'Oilers', 'Calgary Flames': 'Flames', 'Vancouver Canucks': 'Canucks',
                        'Seattle Kraken': 'Kraken', 'San Jose Sharks': 'Sharks', 'Anaheim Ducks': 'Ducks',
                        'Los Angeles Kings': 'Kings', 'Arizona Coyotes': 'Coyotes', 'Utah Mammoth': 'Mammoth',
                        'Utah Hockey Club': 'Mammoth', 'Utah HC': 'Mammoth'
                    };
                    
                    const oppTeamName = teamFullNames[opponent];
                    // Try to find team by full name first, then by partial match
                    let oppTeamData = teamShotData.find(t => t.teamFullName === oppTeamName);
                    
                    // Fallback: try to match by abbreviation, partial name, or normalized name (handles accents)
                    if (!oppTeamData) {
                        oppTeamData = teamShotData.find(t => 
                            t.abbrev === opponent || 
                            t.teamFullName.includes(opponent) ||
                            oppTeamName.includes(t.abbrev) ||
                            normalizeTeamName(t.teamFullName) === normalizeTeamName(oppTeamName)
                        );
                    }
                    
                    let shotRankBadge = '';
                    if (oppTeamData) {
                        // Color code: 1-10 = red (high shots), 11-22 = orange (medium), 23-32 = green (low shots)
                        let badgeColor = '#27ae60'; // green
                        if (oppTeamData.rank <= 10) {
                            badgeColor = '#e74c3c'; // red
                        } else if (oppTeamData.rank <= 22) {
                            badgeColor = '#f39c12'; // orange
                        }
                        shotRankBadge = `<span style="background: ${badgeColor}; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.85em; font-weight: bold; margin-left: 5px;">#${oppTeamData.rank}</span>`;
                    }
                    
                    const shotsAgainst = game.shotsAgainst || 0;
                    const goalsAgainst = game.goalsAgainst || 0;
                    const saves = shotsAgainst - goalsAgainst;
                    const savePct = game.savePctg ? (game.savePctg * 100).toFixed(1) + '%' : 'N/A';
                    
                    return `
                        <tr class="${hit ? 'hit' : 'miss'}">
                            <td>${gameDate}</td>
                            <td>${homeAway} ${opponent} ${shotRankBadge}</td>
                            <td>${saves}</td>
                            <td>${shotsAgainst}</td>
                            <td>${goalsAgainst}</td>
                            <td>${savePct}</td>
                            <td>${game.decision || 'N/A'}</td>
                        </tr>
                    `;
                } else {
                    // Skater row - add opponent defensive info for shots stat
                    let oppDefenseInfo = '';
                    if (currentStatType === 'shots') {
                        const teamFullNames = {
                            'TOR': 'Toronto Maple Leafs', 'BOS': 'Boston Bruins', 'TBL': 'Tampa Bay Lightning',
                            'FLA': 'Florida Panthers', 'MTL': 'Montr√©al Canadiens', 'OTT': 'Ottawa Senators',
                            'BUF': 'Buffalo Sabres', 'DET': 'Detroit Red Wings', 'NYR': 'New York Rangers',
                            'NYI': 'New York Islanders', 'NJD': 'New Jersey Devils', 'PIT': 'Pittsburgh Penguins',
                            'WSH': 'Washington Capitals', 'PHI': 'Philadelphia Flyers', 'CBJ': 'Columbus Blue Jackets',
                            'CAR': 'Carolina Hurricanes', 'NSH': 'Nashville Predators', 'WPG': 'Winnipeg Jets',
                            'MIN': 'Minnesota Wild', 'COL': 'Colorado Avalanche', 'DAL': 'Dallas Stars',
                            'CHI': 'Chicago Blackhawks', 'STL': 'St. Louis Blues', 'VGK': 'Vegas Golden Knights',
                            'EDM': 'Edmonton Oilers', 'CGY': 'Calgary Flames', 'VAN': 'Vancouver Canucks',
                            'SEA': 'Seattle Kraken', 'SJS': 'San Jose Sharks', 'ANA': 'Anaheim Ducks',
                            'LAK': 'Los Angeles Kings', 'ARI': 'Arizona Coyotes', 'UTA': 'Utah Mammoth'
                        };
                        
                        const teamMascots = {
                            'Toronto Maple Leafs': 'Maple Leafs', 'Boston Bruins': 'Bruins', 'Tampa Bay Lightning': 'Lightning',
                            'Florida Panthers': 'Panthers', 'Montr√©al Canadiens': 'Canadiens', 'Montreal Canadiens': 'Canadiens',
                            'Ottawa Senators': 'Senators', 'Buffalo Sabres': 'Sabres', 'Detroit Red Wings': 'Red Wings',
                            'New York Rangers': 'Rangers', 'New York Islanders': 'Islanders', 'New Jersey Devils': 'Devils',
                            'Pittsburgh Penguins': 'Penguins', 'Washington Capitals': 'Capitals', 'Philadelphia Flyers': 'Flyers',
                            'Columbus Blue Jackets': 'Blue Jackets', 'Carolina Hurricanes': 'Hurricanes', 'Nashville Predators': 'Predators',
                            'Winnipeg Jets': 'Jets', 'Minnesota Wild': 'Wild', 'Colorado Avalanche': 'Avalanche', 'Dallas Stars': 'Stars',
                            'Chicago Blackhawks': 'Blackhawks', 'St. Louis Blues': 'Blues', 'Vegas Golden Knights': 'Golden Knights',
                            'Edmonton Oilers': 'Oilers', 'Calgary Flames': 'Flames', 'Vancouver Canucks': 'Canucks',
                            'Seattle Kraken': 'Kraken', 'San Jose Sharks': 'Sharks', 'Anaheim Ducks': 'Ducks',
                            'Los Angeles Kings': 'Kings', 'Arizona Coyotes': 'Coyotes', 'Utah Mammoth': 'Mammoth',
                            'Utah Hockey Club': 'Mammoth', 'Utah HC': 'Mammoth'
                        };
                        
                        const oppTeamName = teamFullNames[opponent];
                        // Try to find team by full name first, then by partial match
                        let oppTeamData = teamShotData.find(t => t.teamFullName === oppTeamName);
                        
                        // Fallback: try to match by abbreviation, partial name, or normalized name (handles accents)
                        if (!oppTeamData) {
                            oppTeamData = teamShotData.find(t => 
                                t.abbrev === opponent || 
                                t.teamFullName.includes(opponent) ||
                                oppTeamName.includes(t.abbrev) ||
                                normalizeTeamName(t.teamFullName) === normalizeTeamName(oppTeamName)
                            );
                        }
                        
                        if (oppTeamData) {
                            const mascot = teamMascots[oppTeamName] || teamMascots[oppTeamData.teamFullName] || opponent;
                            let badgeColor = '#e74c3c'; // red (good defense - low shots against - BAD for shooters)
                            if (oppTeamData.defensiveRank <= 10) {
                                badgeColor = '#27ae60'; // green (bad defense - high shots against - GOOD for shooters)
                            } else if (oppTeamData.defensiveRank <= 22) {
                                badgeColor = '#f39c12'; // orange (medium defense)
                            }
                            oppDefenseInfo = ` <span style="background: ${badgeColor}; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.75em; font-weight: bold;">${mascot} allow ${oppTeamData.shotsAgainstPerGame.toFixed(1)}/g</span>`;
                        } else {
                            // Debug: log when we can't find a team
                            console.log(`Could not find team data for: ${opponent} / ${oppTeamName}`);
                        }
                    }
                    
                    return `
                        <tr class="${hit ? 'hit' : 'miss'}">
                            <td>${gameDate}</td>
                            <td>${homeAway} ${opponent}${oppDefenseInfo}</td>
                            <td>${game.goals || 0}</td>
                            <td>${game.assists || 0}</td>
                            <td>${game.points || 0}</td>
                            <td>${game.shots || 0}</td>
                            <td><strong>${statValue}</strong></td>
                        </tr>
                    `;
                }
            }).join('');

            const hitRate = ((hits / games.length) * 100).toFixed(1);
            const colorClass = getHitRateColor(parseFloat(hitRate));
            
            // Watchlist pin button
            const inWatchlist = isInWatchlist(playerId);
            const watchlistPin = `
                <button onclick="toggleWatchlist(${playerId}, '${name.replace(/'/g, "\\'")}')" 
                        style="position: absolute; top: 15px; right: 60px; background: ${inWatchlist ? '#27ae60' : 'var(--button-bg)'}; color: ${inWatchlist ? 'white' : 'var(--button-text)'}; border: 2px solid ${inWatchlist ? '#27ae60' : 'var(--button-text)'}; border-radius: 8px; padding: 8px 16px; cursor: pointer; font-weight: 600; font-size: 0.9em; transition: all 0.3s;">
                    ${inWatchlist ? 'üìå In Watchlist' : 'üìç Add to Watchlist'}
                </button>
            `;
            
            // Calculate H2H stats if we have a next opponent
            let h2hSection = '';
            if (nextOpponent) {
                // Try to match opponent abbreviation from full name
                const allGames = gameLog.gameLog;
                const h2hStats = calculateH2HStats(allGames, nextOpponent);
                
                console.log('H2H Stats:', h2hStats);
                
                if (h2hStats && h2hStats.games > 0) {
                    const h2hHitRate = calculateH2HHitRate(allGames, h2hStats.opponentAbbrev, lineValue);
                    const h2hColorClass = getHitRateColor(h2hHitRate);
                    
                    h2hSection = `
                        <div class="h2h-section">
                            <div class="h2h-title">üìä Head-to-Head vs ${nextOpponent} (Last ${h2hStats.games} games)</div>
                            <div class="h2h-stats">
                                <div class="h2h-stat">
                                    <div class="h2h-stat-label">Games</div>
                                    <div class="h2h-stat-value">${h2hStats.games}</div>
                                </div>
                                <div class="h2h-stat">
                                    <div class="h2h-stat-label">Avg Goals</div>
                                    <div class="h2h-stat-value">${h2hStats.avgGoals}</div>
                                </div>
                                <div class="h2h-stat">
                                    <div class="h2h-stat-label">Avg Assists</div>
                                    <div class="h2h-stat-value">${h2hStats.avgAssists}</div>
                                </div>
                                <div class="h2h-stat">
                                    <div class="h2h-stat-label">Avg Points</div>
                                    <div class="h2h-stat-value">${h2hStats.avgPoints}</div>
                                </div>
                                <div class="h2h-stat">
                                    <div class="h2h-stat-label">Avg Shots</div>
                                    <div class="h2h-stat-value">${h2hStats.avgShots}</div>
                                </div>
                                <div class="h2h-stat">
                                    <div class="h2h-stat-label">Hit Rate vs ${lineValue}</div>
                                    <div class="h2h-stat-value ${h2hColorClass}">${h2hHitRate.toFixed(1)}%</div>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    // Show message when no H2H history exists
                    h2hSection = `
                        <div class="h2h-section" style="background: var(--card-bg); border: 2px dashed var(--input-border);">
                            <div class="h2h-title" style="color: var(--text-secondary);">üìä Head-to-Head vs ${nextOpponent}</div>
                            <div style="text-align: center; padding: 15px; color: var(--text-secondary); font-style: italic;">
                                No previous games vs ${nextOpponent} this season
                            </div>
                        </div>
                    `;
                    console.log('No H2H games found for opponent:', nextOpponent);
                }
            }
            
            let oddsCard = '';
            if (playerOdds && playerOdds[currentStatType]) {
                const oddsInfo = playerOdds[currentStatType];
                const formattedOdds = oddsInfo.odds > 0 ? `+${oddsInfo.odds}` : oddsInfo.odds;
                
                let oddsLabel = 'Betting Line';
                let oddsValue = `O/U ${oddsInfo.line} ${formattedOdds}`;
                
                if (currentStatType === 'goals' && oddsInfo.type === 'anytime_scorer') {
                    oddsLabel = 'Anytime Goal Scorer';
                    oddsValue = formattedOdds;
                }
                
                oddsCard = `
                    <div class="summary-card">
                        <div class="summary-label">${oddsLabel}</div>
                        <div class="summary-value" style="color: #e67e22; font-size: 1.5em;">${oddsValue}</div>
                    </div>
                `;
            }

            const modalContent = document.getElementById('modalContent');
            modalContent.innerHTML = `
                ${watchlistPin}
                <h2>${name}</h2>
                <p>${player.teamAbbrevs} - ${isGoalieMode ? 'G' : player.positionCode}</p>
                
                <div class="summary-stats">
                    <div class="summary-card">
                        <div class="summary-label">Hit Rate</div>
                        <div class="summary-value ${colorClass}">${hitRate}%</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-label">Hits</div>
                        <div class="summary-value">${hits}/${games.length}</div>
                    </div>
                    ${oddsCard}
                    <div class="summary-card">
                        <div class="summary-label">${isGoalieMode ? 'Season Saves' : 'Season Points'}</div>
                        <div class="summary-value">${isGoalieMode ? (player.saves || 0) : (player.points || 0)}</div>
                    </div>
                </div>
                
                ${playerOdds && playerOdds[currentStatType] ? `
                    <div style="background: var(--warning-bg); padding: 15px; border-radius: 8px; margin: 20px 0; text-align: center; transition: all 0.3s ease;">
                        <div style="font-size: 0.9em; color: var(--warning-text); margin-bottom: 5px; font-weight: 600;">üìÖ This Game</div>
                        <div style="font-size: 1.2em; font-weight: bold; color: var(--text-primary);">${playerOdds[currentStatType].game}</div>
                        <div style="font-size: 0.85em; color: var(--text-secondary); margin-top: 5px;">${new Date(playerOdds[currentStatType].gameTime).toLocaleString('en-US', { weekday: 'short', month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' })}</div>
                        <div style="font-size: 0.85em; color: var(--text-secondary); margin-top: 3px;">Odds from ${playerOdds[currentStatType].bookmaker}</div>
                        ${isGoalieMode && nextOpponent ? (() => {
                            const teamMappings = {
                                'Toronto Maple Leafs': 'TOR', 'Boston Bruins': 'BOS', 'Tampa Bay Lightning': 'TBL',
                                'Florida Panthers': 'FLA', 'Montreal Canadiens': 'MTL', 'Ottawa Senators': 'OTT',
                                'Buffalo Sabres': 'BUF', 'Detroit Red Wings': 'DET', 'New York Rangers': 'NYR',
                                'New York Islanders': 'NYI', 'New Jersey Devils': 'NJD', 'Pittsburgh Penguins': 'PIT',
                                'Washington Capitals': 'WSH', 'Philadelphia Flyers': 'PHI', 'Columbus Blue Jackets': 'CBJ',
                                'Carolina Hurricanes': 'CAR', 'Nashville Predators': 'NSH', 'Winnipeg Jets': 'WPG',
                                'Minnesota Wild': 'MIN', 'Colorado Avalanche': 'COL', 'Dallas Stars': 'DAL',
                                'Chicago Blackhawks': 'CHI', 'St. Louis Blues': 'STL', 'Vegas Golden Knights': 'VGK',
                                'Edmonton Oilers': 'EDM', 'Calgary Flames': 'CGY', 'Vancouver Canucks': 'VAN',
                                'Seattle Kraken': 'SEA', 'San Jose Sharks': 'SJS', 'Anaheim Ducks': 'ANA',
                                'Los Angeles Kings': 'LAK', 'Arizona Coyotes': 'ARI', 'Utah Hockey Club': 'UTA'
                            };
                            const oppTeamData = teamShotData.find(t => t.teamFullName === nextOpponent);
                            if (oppTeamData) {
                                return `<div style="font-size: 0.95em; color: var(--text-primary); margin-top: 8px; font-weight: 600;">üéØ Opponent Shot Volume: #${oppTeamData.rank} (${oppTeamData.shotsPerGame.toFixed(1)} shots/game)</div>`;
                            }
                            return '';
                        })() : !isGoalieMode && currentStatType === 'shots' && nextOpponent ? (() => {
                            const teamMascots = {
                                'Toronto Maple Leafs': 'Maple Leafs', 'Boston Bruins': 'Bruins', 'Tampa Bay Lightning': 'Lightning',
                                'Florida Panthers': 'Panthers', 'Montreal Canadiens': 'Canadiens', 'Ottawa Senators': 'Senators',
                                'Buffalo Sabres': 'Sabres', 'Detroit Red Wings': 'Red Wings', 'New York Rangers': 'Rangers',
                                'New York Islanders': 'Islanders', 'New Jersey Devils': 'Devils', 'Pittsburgh Penguins': 'Penguins',
                                'Washington Capitals': 'Capitals', 'Philadelphia Flyers': 'Flyers', 'Columbus Blue Jackets': 'Blue Jackets',
                                'Carolina Hurricanes': 'Hurricanes', 'Nashville Predators': 'Predators', 'Winnipeg Jets': 'Jets',
                                'Minnesota Wild': 'Wild', 'Colorado Avalanche': 'Avalanche', 'Dallas Stars': 'Stars',
                                'Chicago Blackhawks': 'Blackhawks', 'St. Louis Blues': 'Blues', 'Vegas Golden Knights': 'Golden Knights',
                                'Edmonton Oilers': 'Oilers', 'Calgary Flames': 'Flames', 'Vancouver Canucks': 'Canucks',
                                'Seattle Kraken': 'Kraken', 'San Jose Sharks': 'Sharks', 'Anaheim Ducks': 'Ducks',
                                'Los Angeles Kings': 'Kings', 'Arizona Coyotes': 'Coyotes', 'Utah Hockey Club': 'Hockey Club'
                            };
                            // Try to find team by full name first, then by partial match
                            let oppTeamData = teamShotData.find(t => t.teamFullName === nextOpponent);
                            
                            if (!oppTeamData) {
                                oppTeamData = teamShotData.find(t => 
                                    t.teamFullName.includes(nextOpponent.split(' ').pop()) ||
                                    nextOpponent.includes(t.teamFullName) ||
                                    normalizeTeamName(t.teamFullName) === normalizeTeamName(nextOpponent)
                                );
                            }
                            
                            if (oppTeamData) {
                                const mascot = teamMascots[nextOpponent] || teamMascots[oppTeamData.teamFullName] || nextOpponent.split(' ').pop();
                                return `<div style="font-size: 0.95em; color: var(--text-primary); margin-top: 8px; font-weight: 600;">üéØ ${mascot} allow ${oppTeamData.shotsAgainstPerGame.toFixed(1)} shots/game | ${getOrdinal(oppTeamData.defensiveRank)} most</div>`;
                            }
                            return '';
                        })() : ''}
                    </div>
                ` : ''}
                
                ${h2hSection}

                <h3>Last ${games.length} Games</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Opponent</th>
                            ${isGoalieMode ? `
                                <th>Saves</th>
                                <th>Shots Against</th>
                                <th>GA</th>
                                <th>SV%</th>
                                <th>Decision</th>
                            ` : `
                                <th>Goals</th>
                                <th>Assists</th>
                                <th>Points</th>
                                <th>Shots</th>
                                <th>${currentStatType.charAt(0).toUpperCase() + currentStatType.slice(1)}</th>
                            `}
                        </tr>
                    </thead>
                    <tbody>
                        ${gameRows}
                    </tbody>
                </table>
                ${isGoalieMode ? `
                    <div style="font-size: 0.85em; color: var(--text-secondary); margin-top: 10px; font-style: italic;">
                        üí° Rankings shown next to opponents indicate their shot volume rank (1 = most shots/game, 32 = fewest)<br>
                        üî¥ Red = High volume (1-10) | üü† Orange = Medium volume (11-22) | üü¢ Green = Low volume (23-32)
                    </div>
                ` : currentStatType === 'shots' ? `
                    <div style="font-size: 0.85em; color: var(--text-secondary); margin-top: 10px; font-style: italic;">
                        üí° Badges show shots opponent allows per game (their defensive weakness)<br>
                        üü¢ Green = Weak defense, allows most shots (GOOD for shooters) | üü† Orange = Average | üî¥ Red = Strong defense, allows few shots (BAD for shooters)
                    </div>
                ` : ''}
            `;

            document.getElementById('gameLogModal').style.display = 'block';
        }

        function calculateH2HStats(allGames, opponentFullName) {
            // Team name mappings for matching full names to abbreviations
            const teamMappings = {
                'Toronto Maple Leafs': 'TOR',
                'Boston Bruins': 'BOS',
                'Tampa Bay Lightning': 'TBL',
                'Florida Panthers': 'FLA',
                'Montreal Canadiens': 'MTL',
                'Ottawa Senators': 'OTT',
                'Buffalo Sabres': 'BUF',
                'Detroit Red Wings': 'DET',
                'New York Rangers': 'NYR',
                'New York Islanders': 'NYI',
                'New Jersey Devils': 'NJD',
                'Pittsburgh Penguins': 'PIT',
                'Washington Capitals': 'WSH',
                'Philadelphia Flyers': 'PHI',
                'Columbus Blue Jackets': 'CBJ',
                'Carolina Hurricanes': 'CAR',
                'Nashville Predators': 'NSH',
                'Winnipeg Jets': 'WPG',
                'Minnesota Wild': 'MIN',
                'Colorado Avalanche': 'COL',
                'Dallas Stars': 'DAL',
                'Chicago Blackhawks': 'CHI',
                'St. Louis Blues': 'STL',
                'Vegas Golden Knights': 'VGK',
                'Edmonton Oilers': 'EDM',
                'Calgary Flames': 'CGY',
                'Vancouver Canucks': 'VAN',
                'Seattle Kraken': 'SEA',
                'San Jose Sharks': 'SJS',
                'Anaheim Ducks': 'ANA',
                'Los Angeles Kings': 'LAK',
                'Arizona Coyotes': 'ARI',
                'Utah Hockey Club': 'UTA'
            };
            
            // Find the abbreviation from full name
            const opponentAbbrev = teamMappings[opponentFullName];
            
            if (!opponentAbbrev) {
                console.log('Could not find abbreviation for:', opponentFullName);
                return null;
            }
            
            console.log('Looking for games against:', opponentAbbrev);
            
            const h2hGames = allGames.filter(game => game.opponentAbbrev === opponentAbbrev);
            
            console.log('Found', h2hGames.length, 'games against', opponentAbbrev);
            
            if (h2hGames.length === 0) return null;
            
            let totalGoals = 0;
            let totalAssists = 0;
            let totalPoints = 0;
            let totalShots = 0;
            
            h2hGames.forEach(game => {
                totalGoals += game.goals || 0;
                totalAssists += game.assists || 0;
                totalPoints += game.points || 0;
                totalShots += game.shots || 0;
            });
            
            return {
                games: h2hGames.length,
                avgGoals: (totalGoals / h2hGames.length).toFixed(2),
                avgAssists: (totalAssists / h2hGames.length).toFixed(2),
                avgPoints: (totalPoints / h2hGames.length).toFixed(2),
                avgShots: (totalShots / h2hGames.length).toFixed(2),
                totalGoals,
                totalAssists,
                totalPoints,
                opponentAbbrev
            };
        }

        function calculateH2HHitRate(allGames, opponentAbbrev, lineValue) {
            const h2hGames = allGames.filter(game => game.opponentAbbrev === opponentAbbrev);
            
            if (h2hGames.length === 0) return 0;
            
            let hits = 0;
            h2hGames.forEach(game => {
                let statValue = 0;
                if (currentStatType === 'points') statValue = game.points || 0;
                else if (currentStatType === 'goals') statValue = game.goals || 0;
                else if (currentStatType === 'assists') statValue = game.assists || 0;
                else if (currentStatType === 'shots') statValue = game.shots || 0;
                
                if (statValue > lineValue) hits++;
            });
            
            return (hits / h2hGames.length) * 100;
        }

        function closeModal() {
            document.getElementById('gameLogModal').style.display = 'none';
        }

        window.onclick = function(event) {
            const modal = document.getElementById('gameLogModal');
            if (event.target === modal) {
                closeModal();
            }
        }
    </script>
</body>
</html>
